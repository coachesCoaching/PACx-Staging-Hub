<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PACx Legacy Admin</title>
<style>
  :root{--bg:#0f1223;--panel:#161a2e;--text:#eaf0ff;--sub:#a8b1d1;--mint:#56f3a6;--border:#2a2f4a}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1000px;margin:0 auto;padding:28px 20px 80px}
  .bar{display:flex;align-items:center;gap:12px;margin-bottom:18px}
  .btn{background:var(--mint);color:#02100a;font-weight:800;padding:10px 14px;border:none;border-radius:10px;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
  .list{display:flex;flex-direction:column;gap:14px}
  .tile{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
  .row{display:flex;gap:10px;margin:6px 0}
  .row input,.row textarea{flex:1;background:#0b0e20;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:10px}
  .row textarea{min-height:66px;resize:vertical}
  .actions{display:flex;gap:10px}
  code{background:#0b0e20;padding:2px 6px;border-radius:8px;border:1px solid var(--border)}
  .small{color:var(--sub)}
</style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <a class="btn ghost" href="legacy-hub.html">← Back to Legacy Hub</a>
      <button id="add" class="btn">Add Tile</button>
      <button id="export" class="btn">Export JSON</button>
      <button id="load" class="btn ghost">Load Current JSON</button>
      <div style="flex:1"></div>
      <span class="small">File: <code>/data/legacy-canvases.json</code></span>
    </div>

    <div id="list" class="list"></div>
  </div>

<script>
  const JSON_PATH = 'data/legacy-canvases.json';
  const list = document.getElementById('list');

  let tiles = [];

  document.getElementById('add').onclick = () => {
    tiles.push({title:'', url:'', description:''});
    render();
  };

  document.getElementById('export').onclick = () => {
    const payload = {
      updatedAt: new Date().toISOString(),
      tiles
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
    const a = Object.assign(document.createElement('a'), {
      href: URL.createObjectURL(blob),
      download: 'legacy-canvases.json'
    });
    document.body.appendChild(a);
    a.click();
    a.remove();
  };

  document.getElementById('load').onclick = async () => {
    try{
      const res = await fetch(`${JSON_PATH}?__=${Date.now()}`, {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      tiles = Array.isArray(data.tiles) ? data.tiles : [];
    }catch(e){
      tiles = [];
      console.warn('Could not load existing JSON; starting blank.', e);
    }
    render();
  };

  function move(idx, dir){
    const ni = idx + dir;
    if (ni < 0 || ni >= tiles.length) return;
    [tiles[idx], tiles[ni]] = [tiles[ni], tiles[idx]];
    render();
    window.scrollTo({top: document.getElementById(`tile-${ni}`).offsetTop-12, behavior:'smooth'});
  }

  function del(idx){
    tiles.splice(idx, 1);
    render();
  }

  function render(){
    list.innerHTML = '';
    tiles.forEach((t, i) => {
      const div = document.createElement('div');
      div.className = 'tile';
      div.id = `tile-${i}`;
      div.innerHTML = `
        <div class="actions">
          <button class="btn ghost" onclick="move(${i},-1)">↑</button>
          <button class="btn ghost" onclick="move(${i},+1)">↓</button>
          <button class="btn ghost" onclick="del(${i})">Remove</button>
        </div>
        <div class="row"><input placeholder="Title" value="${esc(t.title)}" oninput="tiles[${i}].title=this.value"/></div>
        <div class="row"><input placeholder="Canvas URL (https://chatgpt.com/canvas/shared/...)" value="${esc(t.url)}" oninput="tiles[${i}].url=this.value"/></div>
        <div class="row"><textarea placeholder="Short description" oninput="tiles[${i}].description=this.value">${esc(t.description||'')}</textarea></div>
        <div class="small">${valid(t.url) ? 'URL OK' : 'Check URL'}</div>
      `;
      list.appendChild(div);
    });
    if(!tiles.length){
      const empty = document.createElement('div');
      empty.className='tile';
      empty.innerHTML = `<div class="row small">No tiles yet. Click <strong>Add Tile</strong>, then <strong>Export JSON</strong> and commit the downloaded file to <code>${JSON_PATH}</code>.</div>`;
      list.appendChild(empty);
    }
  }

  function esc(s=''){return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}
  function valid(u=''){try{const x=new URL(u);return /^https?:$/.test(x.protocol)}catch{return false}}

  // expose for inline handlers
  window.move = move;
  window.del = del;

  // boot with whatever is currently in the JSON (if present)
  document.getElementById('load').click();
</script>
</body>
</html>
