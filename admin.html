<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Canvas Tiles — Admin</title>
<link rel="stylesheet" href="./styles.css">
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="hdot"></div>
    <h1>Canvas Tiles</h1>
  </div>
  <p>Add, rename, update links, and <strong>drag to reorder</strong>. Click <em>Save Tiles</em> then refresh the Canvas Hub.</p>
  <div class="toolbar">
    <button class="btn primary" id="save">Save Tiles</button>
    <button class="btn" id="add">Add Tile</button>
    <button class="btn" id="download">Export JSON</button>
    <label class="btn" for="file">Import JSON</label><input id="file" type="file" accept="application/json" class="hidden">
    <a class="btn" href="./index.html">Back to Hub</a>
    <small class="mono" id="status"></small>
  </div>
  <div class="card">
    <div class="flex"><strong>Tiles</strong><small class="mono">Autosaves locally as you type</small></div>
    <div id="list" class="list"></div>
  </div>
  <footer>
    <p class="note">Server save posts to <code>API_SAVE_ENDPOINT</code>. Configure your serverless function and set the constant below.</p>
  </footer>
</div>
<script>
const API_SAVE_ENDPOINT = 'https://YOUR_SERVER/save-tiles'; // Replace if you deploy serverless save
const LS_KEY = 'pacx_canvas_admin_autosave_v1';
const list = document.getElementById('list');
const statusEl = document.getElementById('status');

function isValidUrl(s){ try{ new URL(s); return true; } catch { return false; } }
function tileRow(t){
  const div = document.createElement('div');
  div.className = 'item';
  div.draggable = true;
  div.innerHTML = `
    <div class="flex">
      <span class="drag">⇅ Drag</span>
      <button class="btn" data-action="remove">Remove</button>
    </div>
    <div class="row">
      <div>
        <label>Title</label>
        <input class="tile-input" name="title" value="${t.title || ''}">
      </div>
      <div>
        <label>Canvas URL</label>
        <input class="tile-input" name="url" value="${t.url || ''}">
      </div>
      <div>
        <label>Description (optional)</label>
        <textarea class="tile-input" name="description" rows="2">${t.description || ''}</textarea>
      </div>
      <div><small class="mono">${isValidUrl(t.url) ? '✓ URL OK' : '⛔ Invalid URL'}</small></div>
    </div>`;
  return div;
}
function readForm(){ return Array.from(list.querySelectorAll('.item')).map(item => ({
  title: item.querySelector('input[name="title"]').value.trim(),
  url: item.querySelector('input[name="url"]').value.trim(),
  description: item.querySelector('textarea[name="description"]').value.trim()
})); }
function writeAutosave(data){ localStorage.setItem(LS_KEY, JSON.stringify(data)); statusEl.textContent = 'Autosaved'; }
function loadAutosave(){ try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); } catch { return []; } }
function render(data){ list.innerHTML = ''; data.forEach(t=> list.appendChild(tileRow(t))); }
async function loadInitial(){
  const auto = loadAutosave();
  if (auto && auto.length) { render(auto); return; }
  try { const res = await fetch('./data/canvases.json?ts=' + Date.now()); const d = await res.json(); render(d.tiles || []);} catch { render([]); }
}
let dragSrc;
list.addEventListener('dragstart', e=>{ dragSrc = e.target.closest('.item'); });
list.addEventListener('dragover', e=>{
  e.preventDefault();
  const cur = e.target.closest('.item');
  if (!cur || cur === dragSrc) return;
  const bb = cur.getBoundingClientRect();
  const after = (e.clientY - bb.top) > (bb.height/2);
  list.insertBefore(dragSrc, after ? cur.nextSibling : cur);
});
list.addEventListener('drop', ()=> scheduleAutosave());
list.addEventListener('click', e=>{ const btn = e.target.closest('button[data-action="remove"]'); if (btn) { btn.closest('.item').remove(); scheduleAutosave(); }});
list.addEventListener('input', e=>{ if (e.target.matches('.tile-input')) scheduleAutosave(); });
list.addEventListener('change', e=>{ if (e.target.matches('.tile-input')) scheduleAutosave(); });
let tmr;
function scheduleAutosave(){ clearTimeout(tmr); tmr = setTimeout(()=> writeAutosave(readForm()), 250); }
document.getElementById('add').addEventListener('click', ()=>{ const data = readForm(); data.push({title:'Untitled',url:'',description:''}); render(data); scheduleAutosave(); });
document.getElementById('download').addEventListener('click', ()=>{ const out={updatedAt:new Date().toISOString(), tiles: readForm()}; const blob=new Blob([JSON.stringify(out,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='canvases.json'; a.click(); });
document.getElementById('file').addEventListener('change', e=>{ const file=e.target.files[0]; if (!file) return; const reader=new FileReader(); reader.onload=()=>{ try{ const obj=JSON.parse(reader.result); render(obj.tiles||[]); writeAutosave(obj.tiles||[]);}catch{ alert('Invalid JSON'); }}; reader.readAsText(file); });
document.getElementById('save').addEventListener('click', async ()=>{ const payload={updatedAt:new Date().toISOString(), tiles: readForm()}; statusEl.textContent='Saving...'; try{ const res=await fetch(API_SAVE_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); if(!res.ok) throw new Error('Server error'); statusEl.textContent='Saved to server'; localStorage.removeItem(LS_KEY);}catch(e){ statusEl.textContent='Save failed (server). Export JSON as backup.'; }});
loadInitial();
</script>
</body></html>
  ...
  <script>
    /* (unchanged admin script) */
  </script>

  <!-- PACx Feedback + Back -->
  <script>
    window.PACX_FEEDBACK_URL = 'https://docs.google.com/forms/d/e/REPLACE_ME/viewform?embedded=true';
    window.PACX_BACK_HREF = 'hub.html';
  </script>
  <script src="./pacx-feedback.js" defer></script>
</body>
</html>
